repos:
  - repo: local
    hooks:
      # 1) Проверка имени ветки
      - id: branch-name
        name: Validate branch name
        language: system
        entry: bash -lc
        args:
          - |
            branch="$(git rev-parse --abbrev-ref HEAD)"
            echo "Branch: $branch"
            if [[ ! "$branch" =~ ^(feature|fix|hotfix|refactor|chore|docs|test|perf|ci|release)/([a-z0-9]+(-[a-z0-9]+)*)(-CB-[0-9]+)?$ ]]; then
              echo "✖ Invalid branch name."
              echo "  Expected: <type>/<scope>-<kebab-desc>[-CB-<num>]"
              echo "  Types: feature|fix|hotfix|refactor|chore|docs|test|perf|ci|release"
              exit 1
            fi
        stages: [pre-commit]
        pass_filenames: false
        always_run: true

      # 2) Проверка заголовка коммита
      - id: commit-message
        name: Validate commit message (Conventional Commits)
        language: system
        entry: bash -lc
        args:
          - |
            msgfile="$1"
            header="$(head -n1 "$msgfile")"
            re='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z0-9-]+\))?(!)?: [^ ].{0,71}$'
            if [[ ! "$header" =~ $re ]]; then
              echo "✖ Invalid commit header:"
              echo "  $header"
              echo "  Expected: <type>(<scope>)?(!)?: <subject up to 72 chars>"
              echo "  Types: feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert"
              exit 1
            fi
            if grep -qE '^BREAKING CHANGE:' "$msgfile" && [[ "$header" != *"!"* ]]; then
              echo "✖ BREAKING CHANGE in body requires '!' in header"
              exit 1
            fi
          - hook # это будет $0 для -c, а путь к файлу попадёт в $1
        stages: [commit-msg]
        pass_filenames: true
        always_run: true

  # --- Ruff ---
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.14.3
    hooks:
      - id: ruff-check
        args: [--fix]
      - id: ruff-format
